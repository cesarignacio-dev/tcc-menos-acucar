<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Gateway</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // Configuração segura do Firebase (Admin)
        const firebaseConfig = {
            apiKey: "AIzaSyAVpktje25KeEVRyGAlyPgNLQntimjJHv8",
            authDomain: "vida-sem-acucar.firebaseapp.com",
            projectId: "vida-sem-acucar",
            storageBucket: "vida-sem-acucar.firebasestorage.app",
            messagingSenderId: "311007666719",
            appId: "1:311007666719:web:bcadc6ed3f850813d3eb2a"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        const _hke = "5i46pFBViYaAfbs46VF7DOtBGr73"; // UID do Administrador
        let _stream = null; 

        // SISTEMA DE ALERTAS (MODAL CUSTOMIZADO)
        let confirmCb = null;
        window.showAlert = (msg) => {
            document.getElementById('alert-msg').innerText = msg;
            document.getElementById('btn-cancel').classList.add('hidden');
            document.getElementById('modal-alert').classList.remove('hidden');
            confirmCb = null;
        };
        window.showConfirm = (msg, cb) => {
            document.getElementById('alert-msg').innerText = msg;
            document.getElementById('btn-cancel').classList.remove('hidden');
            document.getElementById('modal-alert').classList.remove('hidden');
            confirmCb = cb;
        };
        window.closeAlert = () => { document.getElementById('modal-alert').classList.add('hidden'); if(confirmCb) { confirmCb(); confirmCb=null; } };

        window.logar = () => signInWithPopup(auth, provider).catch(() => window.showAlert("Erro de conexão"));
        window.sair = () => { if(_stream) _stream(); signOut(auth); };

        // Proteção de Rota (Apenas UID autorizado entra)
        onAuthStateChanged(auth, user => {
            const l = document.getElementById('login');
            const p = document.getElementById('painel');

            if (user && user.uid === _hke) {
                l.classList.add('hidden');
                p.classList.remove('hidden');
                lerDados();
            } else {
                if(user) { window.showAlert("Acesso negado."); signOut(auth); }
                l.classList.remove('hidden');
                p.classList.add('hidden');
            }
        });

        // CRUD: Criar Produto
        window.salvar = async (e) => {
            e.preventDefault();
            try {
                await addDoc(collection(db, "produtos"), {
                    nome: document.getElementById('nome').value.trim(),
                    marca: document.getElementById('marca').value.trim(),
                    categoria: document.getElementById('cat').value,
                    imagem: document.getElementById('img').value.trim(),
                    data: new Date()
                });
                e.target.reset();
                window.showAlert("Produto salvo!");
            } catch (error) { window.showAlert("Erro de permissão."); }
        };

        // CRUD: Deletar Produto
        window.apagar = async (id) => {
            showConfirm("Apagar este produto?", async () => {
                try { await deleteDoc(doc(db, "produtos", id)); window.showAlert("Apagado."); } 
                catch (error) { window.showAlert("Erro ao apagar."); }
            });
        };

        // CRUD: Ler Produtos (Realtime)
        function lerDados() {
            _stream = onSnapshot(collection(db, "produtos"), (snap) => {
                const list = document.getElementById('lista');
                document.getElementById('total').innerText = snap.size;
                list.innerHTML = '';
                snap.forEach(d => {
                    const p = d.data();
                    list.innerHTML += `
                        <div class="flex items-center justify-between p-4 border-b border-slate-100 hover:bg-slate-50">
                            <div class="flex items-center gap-4">
                                <img src="${p.imagem}" class="w-12 h-12 rounded object-cover bg-slate-200">
                                <div><p class="font-bold text-sm text-slate-900">${p.nome}</p><p class="text-xs uppercase text-slate-400">${p.marca}</p></div>
                            </div>
                            <button onclick="apagar('${d.id}')" class="text-xs font-bold text-red-500 bg-red-50 px-3 py-1.5 rounded hover:bg-red-100">EXCLUIR</button>
                        </div>`;
                });
            });
        }
    </script>
    <style>body { font-family: 'Inter', sans-serif; background-color: #F8FAFC; }</style>
</head>
<body class="text-slate-800">

    <div id="modal-alert" class="fixed inset-0 bg-slate-900/80 z-50 flex items-center justify-center p-6 hidden backdrop-blur-sm">
        <div class="bg-white w-full max-w-xs rounded-2xl p-6 shadow-2xl text-center">
            <p id="alert-msg" class="text-sm font-bold text-slate-800 mb-6">Mensagem</p>
            <div class="flex gap-2">
                <button id="btn-cancel" onclick="closeAlert()" class="flex-1 py-3 bg-slate-100 text-slate-500 font-bold rounded-xl text-xs uppercase hidden">Cancelar</button>
                <button onclick="closeAlert()" class="flex-1 py-3 bg-slate-900 text-white font-bold rounded-xl text-xs uppercase">OK</button>
            </div>
        </div>
    </div>

    <div id="login" class="min-h-screen flex items-center justify-center bg-slate-900 p-6">
        <div class="bg-white w-full max-w-sm p-8 rounded-2xl text-center">
            <h1 class="text-xl font-black mb-2">Gateway ERP</h1>
            <p class="text-xs uppercase font-bold text-slate-400 mb-6">Acesso Restrito</p>
            <button onclick="logar()" class="w-full py-3 bg-slate-900 text-white rounded-lg font-bold text-xs uppercase tracking-widest hover:bg-black">Autenticar</button>
        </div>
    </div>

    <div id="painel" class="hidden min-h-screen max-w-2xl mx-auto bg-white shadow-xl min-h-screen border-x border-slate-100">
        <header class="p-6 border-b border-slate-100 flex justify-between items-center bg-white sticky top-0 z-10">
            <div><h2 class="font-black text-sm uppercase">Gestão</h2><p class="text-[9px] font-bold text-green-600 uppercase tracking-widest">Online</p></div>
            <button onclick="sair()" class="text-[9px] font-bold text-slate-400 hover:text-red-500 bg-slate-50 px-3 py-1.5 rounded">SAIR</button>
        </header>
        <div class="p-6 space-y-6">
            <form onsubmit="salvar(event)" class="bg-slate-50 p-5 rounded-xl border border-slate-100 space-y-4">
                <input id="nome" class="w-full p-3 bg-white rounded border border-slate-200 text-sm outline-none" placeholder="Nome do Produto" required>
                <div class="grid grid-cols-2 gap-3">
                    <input id="marca" class="w-full p-3 bg-white rounded border border-slate-200 text-sm outline-none" placeholder="Marca" required>
                    <select id="cat" class="w-full p-3 bg-white rounded border border-slate-200 text-sm outline-none">
                        <option value="Bebidas">Bebidas</option>
                        <option value="Alimentos">Alimentos</option>
                        <option value="Doces">Doces</option>
                    </select>
                </div>
                <input id="img" class="w-full p-3 bg-white rounded border border-slate-200 text-sm outline-none" placeholder="URL Imagem (GitHub Raw)" required>
                <button id="btn-salvar" class="w-full py-3 bg-green-600 text-white rounded font-bold text-xs uppercase tracking-widest hover:bg-green-700">CADASTRAR</button>
            </form>
            <div>
                <div class="flex justify-between items-end mb-4"><p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Base de Dados</p><p class="text-xs font-black" id="total">0</p></div>
                <div id="lista" class="border border-slate-100 rounded-xl overflow-hidden bg-white"></div>
            </div>
        </div>
    </div>
</body>
</html>
